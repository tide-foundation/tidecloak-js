# Publishing Policy Builder as an NPM Package

This guide explains how to package and publish the Minimal Policy Builder as an npm package for easy installation and integration into your JavaScript, React, and Next.js SDKs.

## Table of Contents
- [Package Structure](#package-structure)
- [Build Configuration](#build-configuration)
- [Publishing to npm](#publishing-to-npm)
- [Installation Methods](#installation-methods)
- [SDK Integration](#sdk-integration)
- [Usage Examples](#usage-examples)

---

## Package Structure

### 1. Create Package Manifest

Create a `package.json` specifically for the Policy Builder package:

```json
{
  "name": "@yourorg/policy-builder",
  "version": "1.0.0",
  "description": "Minimal-dependency visual policy builder with multi-language code generation",
  "main": "./dist/index.js",
  "module": "./dist/index.esm.js",
  "types": "./dist/index.d.ts",
  "exports": {
    ".": {
      "import": "./dist/index.esm.js",
      "require": "./dist/index.js",
      "types": "./dist/index.d.ts"
    },
    "./styles.css": "./dist/policy-builder.css"
  },
  "files": [
    "dist",
    "README.md",
    "LICENSE"
  ],
  "peerDependencies": {
    "react": ">=18.0.0",
    "react-dom": ">=18.0.0"
  },
  "keywords": [
    "policy-builder",
    "access-control",
    "authorization",
    "visual-builder",
    "code-generation",
    "security",
    "minimal-dependencies"
  ],
  "repository": {
    "type": "git",
    "url": "https://github.com/yourorg/policy-builder"
  },
  "license": "MIT",
  "scripts": {
    "build": "vite build --mode lib",
    "prepublishOnly": "npm run build"
  }
}
```

### 2. Directory Structure for Publishing

```
policy-builder-package/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ PolicyBuilder.tsx
â”‚   â”‚   â”œâ”€â”€ BlockPalette.tsx
â”‚   â”‚   â”œâ”€â”€ PolicyCanvas.tsx
â”‚   â”‚   â”œâ”€â”€ PropertiesPanel.tsx
â”‚   â”‚   â”œâ”€â”€ Select.tsx
â”‚   â”‚   â””â”€â”€ policy-builder.css
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â””â”€â”€ useFetch.tsx
â”‚   â”œâ”€â”€ types.ts
â”‚   â””â”€â”€ index.ts  // Main export file
â”œâ”€â”€ dist/  // Generated by build
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ vite.config.lib.ts
â””â”€â”€ README.md
```

### 3. Export Configuration

Create `src/index.ts` as the main entry point:

```typescript
// Export all components
export { PolicyBuilder } from './components/PolicyBuilder';
export { BlockPalette } from './components/BlockPalette';
export { PolicyCanvas } from './components/PolicyCanvas';
export { PropertiesPanel } from './components/PropertiesPanel';
export { Select } from './components/Select';

// Export hooks
export { useFetch } from './hooks/useFetch';

// Export types
export type {
  PolicyBlock,
  Claim,
  Model,
  CompileResult,
  CodeGenerator
} from './types';

// Export CSS (users must import separately)
// import '@yourorg/policy-builder/styles.css'
```

---

## Build Configuration

### Vite Library Build Config

Create `vite.config.lib.ts`:

```typescript
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import { resolve } from 'path';

export default defineConfig({
  plugins: [react()],
  build: {
    lib: {
      entry: resolve(__dirname, 'src/index.ts'),
      name: 'PolicyBuilder',
      formats: ['es', 'cjs'],
      fileName: (format) => format === 'es' ? 'index.esm.js' : 'index.js'
    },
    rollupOptions: {
      // Externalize peer dependencies
      external: ['react', 'react-dom'],
      output: {
        globals: {
          react: 'React',
          'react-dom': 'ReactDOM'
        }
      }
    },
    sourcemap: true,
    minify: true
  }
});
```

### TypeScript Configuration

Create `tsconfig.json` for the package:

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true,
    "declaration": true,
    "declarationDir": "./dist"
  },
  "include": ["src"]
}
```

---

## Publishing to npm

### 1. Prepare Package

```bash
# Navigate to package directory
cd policy-builder-package

# Install dependencies
npm install

# Build the package
npm run build

# Verify build output
ls -la dist/
```

### 2. Test Locally (Optional)

```bash
# Create tarball
npm pack

# In another project, install from tarball
npm install /path/to/yourorg-policy-builder-1.0.0.tgz
```

### 3. Publish to npm

```bash
# Login to npm (first time only)
npm login

# Publish public package
npm publish --access public

# Or publish scoped package
npm publish
```

### 4. Version Management

```bash
# Patch version (1.0.0 â†’ 1.0.1)
npm version patch

# Minor version (1.0.0 â†’ 1.1.0)
npm version minor

# Major version (1.0.0 â†’ 2.0.0)
npm version major

# Then publish
npm publish
```

---

## Installation Methods

### Method 1: Direct Installation

Users can install directly:

```bash
npm install @yourorg/policy-builder
```

### Method 2: Via Your SDK (Recommended)

Users install your SDK, which includes the Policy Builder:

```bash
# JavaScript SDK
npm install @yourorg/sdk

# React SDK
npm install @yourorg/react-sdk

# Next.js SDK
npm install @yourorg/nextjs-sdk
```

---

## SDK Integration

### JavaScript SDK (`@yourorg/sdk`)

**Structure:**
```
sdk/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts
â”‚   â””â”€â”€ policy-builder.ts
â””â”€â”€ package.json
```

**`package.json`:**
```json
{
  "name": "@yourorg/sdk",
  "dependencies": {
    "@yourorg/policy-builder": "^1.0.0"
  }
}
```

**`src/index.ts`:**
```typescript
// Re-export Policy Builder types and utilities
export type {
  PolicyBlock,
  Claim,
  Model,
  CompileResult,
  CodeGenerator
} from '@yourorg/policy-builder';

// Export other SDK features
export * from './auth';
export * from './api';
```

### React SDK (`@yourorg/react-sdk`)

**Structure:**
```
react-sdk/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts
â”‚   â””â”€â”€ components/
â”‚       â””â”€â”€ PolicyBuilder.tsx  // Optional wrapper
â””â”€â”€ package.json
```

**`package.json`:**
```json
{
  "name": "@yourorg/react-sdk",
  "peerDependencies": {
    "react": ">=18.0.0",
    "react-dom": ">=18.0.0"
  },
  "dependencies": {
    "@yourorg/sdk": "^1.0.0",
    "@yourorg/policy-builder": "^1.0.0"
  }
}
```

**`src/index.ts`:**
```typescript
// Re-export all Policy Builder components
export {
  PolicyBuilder,
  BlockPalette,
  PolicyCanvas,
  PropertiesPanel,
  Select,
  useFetch
} from '@yourorg/policy-builder';

// Re-export types
export type {
  PolicyBlock,
  Claim,
  Model,
  CompileResult,
  CodeGenerator
} from '@yourorg/policy-builder';

// Export other React SDK components
export * from './components/AuthProvider';
export * from './components/ApiClient';
```

### Next.js SDK (`@yourorg/nextjs-sdk`)

**Structure:**
```
nextjs-sdk/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts
â”‚   â”œâ”€â”€ client.ts   // Client components
â”‚   â””â”€â”€ server.ts   // Server utilities
â””â”€â”€ package.json
```

**`package.json`:**
```json
{
  "name": "@yourorg/nextjs-sdk",
  "peerDependencies": {
    "react": ">=18.0.0",
    "react-dom": ">=18.0.0",
    "next": ">=14.0.0"
  },
  "dependencies": {
    "@yourorg/sdk": "^1.0.0",
    "@yourorg/policy-builder": "^1.0.0"
  }
}
```

**`src/client.ts`:**
```typescript
'use client';

// Re-export Policy Builder (client components only)
export {
  PolicyBuilder,
  BlockPalette,
  PolicyCanvas,
  PropertiesPanel,
  Select,
  useFetch
} from '@yourorg/policy-builder';

export type {
  PolicyBlock,
  Claim,
  Model
} from '@yourorg/policy-builder';
```

**`src/server.ts`:**
```typescript
// Server-side utilities
export type {
  CodeGenerator,
  CompileResult
} from '@yourorg/policy-builder';

// Server-side helpers
export async function compilePolicy(blocks: PolicyBlock[]) {
  // Server-side compilation logic
}
```

---

## Usage Examples

### Direct Installation

```typescript
import {
  PolicyBuilder,
  type PolicyBlock,
  type Claim
} from '@yourorg/policy-builder';
import '@yourorg/policy-builder/styles.css';

function App() {
  return <PolicyBuilder />;
}
```

### Via JavaScript SDK

```typescript
import type { PolicyBlock, Claim } from '@yourorg/sdk';
// Import React components from React SDK
```

### Via React SDK

```typescript
import {
  PolicyBuilder,
  type PolicyBlock,
  type Claim
} from '@yourorg/react-sdk';
import '@yourorg/policy-builder/styles.css';

function App() {
  return <PolicyBuilder />;
}
```

### Via Next.js SDK (App Router)

```typescript
'use client';

import {
  PolicyBuilder,
  type PolicyBlock
} from '@yourorg/nextjs-sdk/client';
import '@yourorg/policy-builder/styles.css';

export default function PolicyPage() {
  return <PolicyBuilder />;
}
```

### Server-Side (Next.js)

```typescript
import { compilePolicy } from '@yourorg/nextjs-sdk/server';
import type { PolicyBlock } from '@yourorg/nextjs-sdk/client';

export async function POST(request: Request) {
  const blocks: PolicyBlock[] = await request.json();
  const result = await compilePolicy(blocks);
  return Response.json(result);
}
```

---

## Best Practices

### 1. Semantic Versioning

- **Patch** (1.0.x): Bug fixes, no breaking changes
- **Minor** (1.x.0): New features, backward compatible
- **Major** (x.0.0): Breaking changes

### 2. Changelog

Maintain a `CHANGELOG.md`:

```markdown
# Changelog

## [1.1.0] - 2025-11-02
### Added
- Python code generator support
- New block types for custom actions

### Fixed
- Duplicate scrollbar issue in properties panel

## [1.0.0] - 2025-11-01
### Added
- Initial release with C# code generator
- Minimal-dependency architecture
- React-only implementation
```

### 3. Documentation

Include in package README:
- Installation instructions
- Basic usage examples
- API reference link
- Migration guide (for breaking changes)

### 4. TypeScript Support

Always include:
- `.d.ts` type definitions
- Source maps for debugging
- Proper `types` field in package.json

### 5. Testing Before Publishing

```bash
# Always test build before publishing
npm run build

# Check what will be published
npm pack --dry-run

# Verify bundle size
ls -lh dist/
```

---

## Monorepo Approach (Alternative)

If you prefer a monorepo with all SDKs:

```
monorepo/
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ policy-builder/     # Core package
â”‚   â”œâ”€â”€ sdk/                # JS SDK
â”‚   â”œâ”€â”€ react-sdk/          # React SDK
â”‚   â””â”€â”€ nextjs-sdk/         # Next.js SDK
â”œâ”€â”€ package.json
â””â”€â”€ lerna.json              # Or pnpm-workspace.yaml
```

This allows:
- Shared version management
- Easier cross-package development
- Consistent release process

---

## Summary

1. **Package Setup**: Configure `package.json` with proper exports
2. **Build**: Use Vite to bundle as library (ES + CJS)
3. **Publish**: `npm publish` to registry
4. **SDK Integration**: Re-export in your JS/React/Next.js SDKs
5. **User Installation**: Users install your SDK, get Policy Builder automatically

**Result**: Users can `npm install @yourorg/react-sdk` and immediately use the Policy Builder without copying files! ðŸŽ‰
